#!/bin/sh
# A veure si ho esgarrem tot

cat <<'EOF' > /etc/jail.conf
# Common configs for all jails
allow.nomount;
exec.start = "/bin/sh /etc/rc";
exec.stop = "/bin/sh /etc/rc.shutdown";
exec.clean;
host.hostname = "$name.hermes.cat";
mount.devfs;
path = "/zroot/jails/$name";
ip4.addr = 172.16.16.$ip/24;
interface = "bridge0";

# Correu
correu {
	$ip = 11;
}

# Web
web {
	$ip = 12;
}

# Plex
plex {
	$ip = 13;
}

# TVHeadEnd
tvhe {
	$ip = 14;
}

EOF

cd /

zfs create zroot/jails

zfs create zroot/jails/_base
bsdinstall jail /zroot/jails/_base
chroot /zroot/jails/_base

rm /zroot/jails/_base/etc/rc.conf

cat <<'EOF' > /zroot/jails/_base/etc/rc.conf
sshd_enable="YES"
dumpdev="NO"
sendmail_enable="NONE"
sendmail_submit_enable="NO"
sendmail_outbound_enable="NO"
sendmail_msp_queue_enable="NO"
syslogd_enable="NO"

EOF

rm /zroot/jails/_base/etc/resolv.conf

cat <<'EOF' > /zroot/jails/_base/etc/resolv.conf
nameserver 172.16.16.1
options edns0

EOF

cat <<'EOF' >> /zroot/jails/_base/etc/ssh/sshd_config
PermitRootLogin yes
PasswordAuthentication yes

EOF

zfs snapshot zroot/jails/_base@11.0-bootstrapped

zfs send -R zroot/jails/_base@11.0-bootstrapped | zfs receive zroot/jails/correu
zfs send -R zroot/jails/_base@11.0-bootstrapped | zfs receive zroot/jails/web
zfs send -R zroot/jails/_base@11.0-bootstrapped | zfs receive zroot/jails/plex
zfs send -R zroot/jails/_base@11.0-bootstrapped | zfs receive zroot/jails/tvhe

mkdir -p /zroot/jails/plex/{video,audio}

cat 'plexmediaserver_enable="YES"' >> /zroot/jails/plex/etc/rc.conf

cat <<'EOF' >> /zroot/jails/tvhe/etc/rc.conf
tvheadend_enable="YES"
tvheadend_flags="-C"

EOF


service jail start correu
service jail start web
service jail start plex
service jail start tvhe

pkg -j correu install -y opensmtpd
pkg -j web install -y nginx
pkg -j plex install -y plexmediaserver
pkg -j tvhe install -y tvheadend

service jail restart correu
service jail restart web
service jail restart plex
service jail restart tvhe

echo 'Acabat tot!'
echo 'Toca fusta ...'

